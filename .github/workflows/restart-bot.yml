name: ğŸ¤– Auto Restart Bot

on:
  schedule:
    - cron: '0 3 */5 * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ´Ğ½ĞµĞ¹ Ğ² 03:00 UTC
  workflow_dispatch:        # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

jobs:
  restart-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”‘ Get GitHub Token
      uses: tibdex/github-app-token@v2
      id: generate-token
      with:
        app_id: ${{ secrets.APP_ID }}
        private_key: ${{ secrets.APP_PRIVATE_KEY }}
    
    - name: ğŸ›‘ Stop Old Codespaces
      run: |
        echo "ğŸ›‘ Stopping old codespaces..."
        RESPONSE=$(curl -s -H "Authorization: token ${{ steps.generate-token.outputs.token }}" \
          "https://api.github.com/user/codespaces?per_page=100")
        
        # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ codespaces
        echo "$RESPONSE" | jq -r '.[] | select(.state == "Available") | .name' | while read name; do
          echo "ğŸ›‘ Stopping: $name"
          curl -s -X POST \
            -H "Authorization: token ${{ steps.generate-token.outputs.token }}" \
            "https://api.github.com/user/codespaces/$name/stop"
        done
        
        sleep 30  # Ğ–Ğ´ĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸

    - name: ğŸ†• Create New Codespace
      run: |
        echo "ğŸš€ Creating new codespace..."
        REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
        
        RESPONSE=$(curl -s -X POST \
          -H "Authorization: token ${{ steps.generate-token.outputs.token }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"repository\": \"${{ github.repository }}\",
            \"machine\": \"standardLinux32gb\",
            \"display_name\": \"Telegram-Bot-$(date +%Y%m%d)\"
          }" \
          "https://api.github.com/user/codespaces")
        
        echo "âœ… Codespace creation response: $RESPONSE"
        
    - name: ğŸ“ Status
      run: |
        echo "âœ… Auto-restart setup completed!"
        echo "ğŸ• Next auto-restart in 5 days"
        echo "ğŸš€ You can also trigger manually in Actions tab"
